name: Build MSPP4 and Create Installer (rpm)

on:
  push:
    branches: [ main , develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'zulu'
  GITHUB_ACTOR: ${{ github.actor }}
  GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    container:
      image: almalinux:9

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install deps
      run: |
        dnf install -y rpm-build

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        java-package: jdk+fx
        #server-id: github
        #server-username: GITHUB_ACTOR
        #server-password: GITHUB_TOKEN

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: almalinux9-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: almalinux9-m2

    - name: Checkout mspp4-core repository
      uses: actions/checkout@v4
      with:
        repository: masspp/mspp4-core
        path: mspp4-core

    - name: Set execute permissions for Maven wrapper
      run: chmod +x ./mvnw

    - name: Build mspp4-core
      working-directory: ./mspp4-core
      run: |
        ./mvnw clean package install -DskipTests
      shell: bash

    - name: Generate settings.xml
      uses: s4u/maven-settings-action@v4.0.0
      with:
        servers: |
          [{ "id": "github", "username": "${{ github.actor }}", "password": "${{ secrets.GITHUB_TOKEN }}" }]

    - name: Build mspp-desktop
      run: |
        cat > ~/.m2/settings.xml <<EOF
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>github</id>
              <username>$GITHUB_ACTOR</username>
              <password>$GITHUB_TOKEN</password>
            </server>
          </servers>
        </settings>
        EOF
        cat ~/.m2/settings.xml
        echo "GITHUB_ACTOR (shell): $GITHUB_ACTOR"
        echo "GITHUB_TOKEN (shell): ${GITHUB_TOKEN:0:10}..."
        ./mvnw clean license:third-party-report package -DskipTests
      shell: bash

    - name: Set up application version
      id: version
      run: |
        if [[ "$GITHUB_REF" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="1.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "App version: $VERSION"
      shell: bash

    - name: Create runtime image with jlink
      run: |
        $JAVA_HOME/bin/jlink \
          --add-modules java.base,java.desktop,java.logging,java.xml,java.prefs,java.datatransfer,java.sql,java.scripting,javafx.base,javafx.controls,javafx.fxml \
          --output runtime-image \
          --strip-debug \
          --compress=2 \
          --no-header-files \
          --no-man-pages
      shell: bash

    - name: Create installer with jpackage (Linux)
      run: |
        $JAVA_HOME/bin/jpackage \
          --input ./target \
          --name "MS++4" \
          --main-jar mspp4-desktop-jar-with-dependencies.jar \
          --main-class ninja.mspp.MsppLauncher \
          --type rpm \
          --dest installers \
          --runtime-image runtime-image \
          --app-version ${{ steps.version.outputs.VERSION }} \
          --vendor "MS++4 Team" \
          --description "Mass Spectrometry Plus-Plus Platform 4" \
          --copyright "Copyright Â© 2025 MS++4 Team" \
          --linux-shortcut \
          --linux-menu-group "Science"

    - name: List created installers
      run: |
        ls -la installers/
      shell: bash

    - name: Upload installer artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mspp4-installer-linux
        path: installers/*
        retention-days: 30

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-linux
        path: |
          mspp4-core/target/surefire-reports/
          mspp-desktop/target/surefire-reports/
        retention-days: 7

